<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial weights objects as sparse matrices and graphs • spatialreg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial weights objects as sparse matrices and graphs">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spatialreg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3-6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/nb_igraph.html">Spatial weights objects as sparse matrices and graphs</a></li>
    <li><a class="dropdown-item" href="../articles/sids_models.html">North Carolina SIDS data set (models)</a></li>
    <li><a class="dropdown-item" href="../articles/SpatialFiltering.html">Moran Eigenvectors</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-spatial/spatialreg/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spatial weights objects as sparse matrices and graphs</h1>
                        <h4 data-toc-skip class="author">Roger
Bivand</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/spatialreg/blob/HEAD/vignettes/nb_igraph.Rmd" class="external-link"><code>vignettes/nb_igraph.Rmd</code></a></small>
      <div class="d-none name"><code>nb_igraph.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Since the <strong>spdep</strong> package was created, <em>spatial
weights</em> objects have been constructed as lists with three
components and a few attributes, in old-style class <code>listw</code>
objects. The first component of a <code>listw</code> object is an
<code>nb</code> object, a list of <code>n</code> integer vectors, with
at least a character vector <code>region.id</code> attribute with
<code>n</code> unique values (like the <code>row.names</code> of a
<code>data.frame</code> object); <code>n</code> is the number of spatial
entities. Component <code>i</code> of this list contains the integer
identifiers of the neighbours of <code>i</code> as a sorted vector with
no duplication and values in <code>1:n</code>; if <code>i</code> has no
neighbours, the component is a vector of length <code>1</code> with
value <code>0L</code>. The <code>nb</code> object may contain an
attribute indicating whether it is symmetric or not, that is whether
<code>i</code> is a neighbour of <code>j</code> implies that
<code>j</code> is a neighbour of <code>i</code>. Some neighbour
definitions are symmetric by construction, such as contiguities or
distance thresholds, others are asymmetric, such as
<code>k</code>-nearest neighbours. The <code>nb</code> object
redundantly stores both <code>i</code>-<code>j</code> and
<code>j</code>-<code>i</code> links.</p>
<p>The second component of a <code>listw</code> object is a list of
<code>n</code> numeric vectors, each of the same length as the
corresponding non-zero vectors in the <code>nb</code>object. These give
the values of the spatial weights for each <code>i</code>-<code>j</code>
neighbour pair. It is often the case that while the neighbours are
symmetric by construction, the weights are not, as for example when
weights are <em>row-standardised</em> by dividing each row of input
weights by the count of neighbours or cardinality of the neighbour set
of <code>i</code>. In the <code>nb2listw</code>function, it is also
possible to pass through general weights, such as inverse distances,
shares of boundary lengths and so on.</p>
<p>The third component of a <code>listw</code> object records the
<code>style</code> of the weights as a character code, with
<code>"B"</code> for binary weights taking values zero or one (only one
is recorded), <code>"W"</code> for row-standardised weights, and so on.
In order to subset <code>listw</code> objects, knowledge of the
<code>style</code> may be necessary</p>
<p>It is obvious that this is similar to the way in which sparse
matrices are stored, either by row - like the <code>listw</code> object,
or by column. The key insight is that storing zero values is
unnecessary, as we only need to store the row and column locations of
non-zero values. Early on, a Netlib library was used to provide limited
support in <strong>spdep</strong> for sparse matrices, followed by
functionality in <strong>SparseM</strong>, <strong>spam</strong>, and
<strong>Matrix</strong>.</p>
<p>From <strong>spdep</strong> and <strong>spatialreg</strong> versions
1.2, this vignette and accompanying functionality has been moved to
<strong>spatialreg</strong>.</p>
<div class="section level3">
<h3 id="spatialreg-depends-on-matrix">
<strong>spatialreg</strong> depends on <strong>Matrix</strong><a class="anchor" aria-label="anchor" href="#spatialreg-depends-on-matrix"></a>
</h3>
<p>Since <strong>Matrix</strong> is a recommended package, its
functionality has increasingly been used over time, and it has become
one of two packages on which <strong>spatialreg</strong> depends. This
is reported on loading:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/" class="external-link">spatialreg</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: spData</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: Matrix</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: sf</span></span></code></pre>
<pre><code><span><span class="co">## Linking to GEOS 3.13.0, GDAL 3.10.0, PROJ 9.5.0; sf_use_s2() is TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="getting-some-data">Getting some data<a class="anchor" aria-label="anchor" href="#getting-some-data"></a>
</h3>
<p>The legacy Columbus OH data set has 49 spatial entities, polygons,
defined as the boundaries of policing districts in the city.
<strong>spatialreg</strong> imports from <strong>spdep</strong> which in
turn depends on <strong>sf</strong>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dothis</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"install the sf package"</span><span class="op">)</span></span>
<span>  <span class="va">dothis</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">dothis</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_extSoftVersion.html" class="external-link">sf_extSoftVersion</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##           GEOS           GDAL         proj.4 GDAL_with_GEOS     USE_PROJ_H </span></span>
<span><span class="co">##       "3.13.0"       "3.10.0"        "9.5.0"         "true"         "true" </span></span>
<span><span class="co">##           PROJ </span></span>
<span><span class="co">##        "9.5.0"</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="va">columbus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shapes/columbus.gpkg"</span>, package<span class="op">=</span><span class="st">"spData"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `columbus' from data source </span></span>
<span><span class="co">##   `/home/rsb/lib/r_libs/spData/shapes/columbus.gpkg' using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 49 features and 20 fields</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 5.874907 ymin: 10.78863 xmax: 11.28742 ymax: 14.74245</span></span>
<span><span class="co">## Projected CRS: Undefined Cartesian SRS with unknown unit</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">columbus</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="finding-contiguous-neighbours-and-droppping-links">Finding contiguous neighbours and droppping links<a class="anchor" aria-label="anchor" href="#finding-contiguous-neighbours-and-droppping-links"></a>
</h3>
<p>Contiguous neighbours are often used for polygonal spatial entities,
here with the <strong>poly2nb</strong> function defaulting to the
<em>queen</em> criterion - entities are neighbours if they share a
boundary point. We see that the entity IDs are copied across to the
<code>nb</code> object:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_q</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="va">columbus</span><span class="op">)</span></span>
<span><span class="va">nb_q</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 49 </span></span>
<span><span class="co">## Number of nonzero links: 236 </span></span>
<span><span class="co">## Percentage nonzero weights: 9.829238 </span></span>
<span><span class="co">## Average number of links: 4.816327</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_q</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10"</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/testnb.html" class="external-link">is.symmetric.nb</a></span><span class="op">(</span><span class="va">nb_q</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>In order to make the object more complicated, let us drop the
neighbour links for the 21st entity (noting that the print method
reports the ID of the entity with no neighbours, not its number in
<code>1:n</code>), and plot the resulting map of neighbours:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col2</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/droplinks.html" class="external-link">droplinks</a></span><span class="op">(</span><span class="va">nb_q</span>, <span class="fl">21</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in spdep::droplinks(nb_q, 21): some observations have no neighbours</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::droplinks(nb_q, 21): neighbour object has 3 sub-graphs</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_q</span><span class="op">[[</span><span class="fl">21</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 24 30 34</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col2</span><span class="op">[[</span><span class="fl">21</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col2</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 49 </span></span>
<span><span class="co">## Number of nonzero links: 230 </span></span>
<span><span class="co">## Percentage nonzero weights: 9.579342 </span></span>
<span><span class="co">## Average number of links: 4.693878 </span></span>
<span><span class="co">## 1 region with no links:</span></span>
<span><span class="co">## 21</span></span>
<span><span class="co">## 3 disjoint connected subgraphs</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/testnb.html" class="external-link">is.symmetric.nb</a></span><span class="op">(</span><span class="va">col2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">columbus</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nb_q</span>, <span class="va">coords</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">col2</span>, <span class="va">coords</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="nb_igraph_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="using-sparse-matrices-to-represent-spatial-weights">Using sparse matrices to represent spatial weights<a class="anchor" aria-label="anchor" href="#using-sparse-matrices-to-represent-spatial-weights"></a>
</h2>
<p>At present only <code>listw</code> objects can be coerced to objects
of classes defined in <strong>Matrix</strong>. Because the
<code>style</code> is lost on coercion, it may not be possible to
reconstruct spatial weights as the sparse matrix representation does not
preserve it. We will start with symmetric binary weights, first creating
a spatial weights object, and signalling that one entity has no
neighbours with the <code>zero.policy</code> argument (default false).
The matrix and graph representations of no-neighbour entities are not
obvious.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_B</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">col2</span>, style<span class="op">=</span><span class="st">"B"</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">nb_B</span><span class="op">$</span><span class="va">style</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "B"</span></span></code></pre>
<div class="section level3">
<h3 id="symmetric-sparse-matrices">Symmetric sparse matrices<a class="anchor" aria-label="anchor" href="#symmetric-sparse-matrices"></a>
</h3>
<p><strong>spdep</strong> provides coercion methods from
<code>listw</code> to the <code>"symmetricMatrix"</code>,
<code>"RsparseMatrix"</code> and <code>"CsparseMatrix"</code> classes
defined in <strong>Matrix</strong>. The <code>"RsparseMatrix"</code> is
the representation that is most similar to <code>listw</code>, as it is
row-based, but it is used less frequently in operations on sparse
matrices. The entity IDs are passed using sparse matrix row and column
names at present. Here we believe that our <code>listw</code> object can
be represented as a symmetric matrix, storing only a triangle rather
than both <code>i</code>-<code>j</code> and
<code>j</code>-<code>i</code> weights. The coercion method does check
whether symmetry is present before proceeding:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/" class="external-link">spatialreg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">nb_B</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">B</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span></span>
<span><span class="co">##   ..@ i       : int [1:230] 1 2 0 2 3 0 1 3 4 1 ...</span></span>
<span><span class="co">##   ..@ p       : int [1:50] 0 2 5 9 13 21 23 27 33 41 ...</span></span>
<span><span class="co">##   ..@ Dim     : int [1:2] 49 49</span></span>
<span><span class="co">##   ..@ Dimnames:List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:49] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:49] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   ..@ x       : num [1:230] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   ..@ factors : list()</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10"</span></span></code></pre>
<p>Let us now try to retreive the list of neighbours from the symmetric
sparse matrix. At present, we have to coerce from one
<strong>Matrix</strong> internal representation to another in order to
get to the <code>"dgCMatrix"</code> format used inside
<code>mat2listw</code>, so we coerce to <code>"dgTMatrix"</code> from
<code>"dsTMatrix"</code>. The style is not retreived automatically, but
is set to <code>"M"</code> to indicate conversion from a matrix. The
neighbour links are retreived correctly, as are the IDs:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_B1</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/mat2listw.html" class="external-link">mat2listw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">B</span>, <span class="st">"TsparseMatrix"</span><span class="op">)</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span>,</span>
<span>    style<span class="op">=</span><span class="st">"B"</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in sn2listw(df, style = style, zero.policy = zero.policy, from_mat2listw = TRUE): no-neighbour observations found, set zero.policy to TRUE;</span></span>
<span><span class="co">## this warning will soon become an error</span></span></code></pre>
<pre><code><span><span class="co">## Warning in sn2listw(df, style = style, zero.policy = zero.policy,</span></span>
<span><span class="co">## from_mat2listw = TRUE): neighbour object has 3 sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::mat2listw(as(as(B, "TsparseMatrix"), "CsparseMatrix"), :</span></span>
<span><span class="co">## neighbour object has 3 sub-graphs</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_B1</span><span class="op">$</span><span class="va">style</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "B"</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">nb_B1</span><span class="op">$</span><span class="va">neighbours</span>, <span class="va">col2</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_B1</span><span class="op">$</span><span class="va">neighbours</span>, <span class="st">"region.id"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_B</span><span class="op">$</span><span class="va">neighbours</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="log-determinants-symmetric-weights-used-in-spatial-regression">Log determinants (symmetric weights) used in spatial regression<a class="anchor" aria-label="anchor" href="#log-determinants-symmetric-weights-used-in-spatial-regression"></a>
</h3>
<p>An initial reason for implementing support for sparse weights
matrices in <strong>spdep</strong> was to permit the calculation of the
log determinant term in spatial regressions for larger data sets. Using
the eigenvalue approach with for example <code><a href="../reference/eigenw.html">spatialreg::eigenw</a></code>
is limited by the need to operate on dense matrices in memory to solve
the eigenproblem:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">do_spatialreg</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"spatialreg"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="va">do_spatialreg</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">do_spatialreg</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="fu">spatialreg</span><span class="fu">::</span><span class="fu"><a href="../reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="va">nb_B</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.44787</span></span></code></pre>
<p>When <code>n</code> is large, this may become impractical and/or
time-consuming, but does permit the rapid calculation of values of the
log determinant for differing values of the spatial coefficient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ρ</mi><annotation encoding="application/x-tex">\rho</annotation></semantics></math>.
The <strong>Matrix</strong> package provides many
<code>determinant</code> methods, here for a <code>"dsCMatrix"</code>
resulting from subtracting a <code>"dsCMatrix"</code>, the product of a
scalar and a <code>"dsTMatrix"</code>, from a <code>"ddiMatrix"</code>.
The value of the log determinant follows, calling a sparse Cholesky
decomposition internally for suitable input matrices.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">B</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "dgCMatrix"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Matrix"</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/det.html" class="external-link">determinant</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">B</span>, logarithm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">modulus</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.44787</span></span></code></pre>
<p>The computation of a sparse Cholesky decomposition for each value of
the spatial coefficient
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ρ</mi><annotation encoding="application/x-tex">\rho</annotation></semantics></math>
may be avoided by updating a pre-computed object; this approach provides
fast and accurate log determinants for larger (but not very large) data
sets:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nW</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">B</span></span>
<span><span class="va">nChol</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Cholesky-methods.html" class="external-link">Cholesky</a></span><span class="op">(</span><span class="va">nW</span>, Imult<span class="op">=</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">rho</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/det.html" class="external-link">determinant</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">nChol</span>, <span class="va">nW</span>, <span class="fl">1</span><span class="op">/</span><span class="va">rho</span><span class="op">)</span>, sqrt<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">modulus</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 15.40218</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="asymmetric-sparse-matrices">Asymmetric sparse matrices<a class="anchor" aria-label="anchor" href="#asymmetric-sparse-matrices"></a>
</h3>
<p>The use of row-standardisation leads to asymmetry even if the
underlying neighbours are symmetric, unless all entities have matching
numbers of neighbours (for example a regular grid on a torus):</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_W</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">col2</span>, style<span class="op">=</span><span class="st">"W"</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">nb_W</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span></span>
<span><span class="co">##   ..@ i       : int [1:230] 1 2 0 2 3 0 1 3 4 1 ...</span></span>
<span><span class="co">##   ..@ p       : int [1:50] 0 2 5 9 13 21 23 27 33 41 ...</span></span>
<span><span class="co">##   ..@ Dim     : int [1:2] 49 49</span></span>
<span><span class="co">##   ..@ Dimnames:List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:49] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:49] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   ..@ x       : num [1:230] 0.333 0.25 0.5 0.25 0.25 ...</span></span>
<span><span class="co">##   ..@ factors : list()</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">W</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<p>The <code>lag</code> method for <code>listw</code> objects is often
used to create spatially lagged values, and returns the same values as
the vector given by the product of the sparse general matrix and an
input numeric vector. Note that by setting <code>zero.policy</code> to
<code>TRUE</code>, the spatial lag of entity 21, which has no
neighbours, is zero by construction:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">nb_W</span>, <span class="va">x</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">r1</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="nb_igraph_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">21</span><span class="op">]</span>, <span class="va">r1</span><span class="op">[</span><span class="fl">21</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.9347052 0.0000000</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="log-determinants-asymmetric-weights-used-in-spatial-regression">Log determinants (asymmetric weights) used in spatial
regression<a class="anchor" aria-label="anchor" href="#log-determinants-asymmetric-weights-used-in-spatial-regression"></a>
</h3>
<p>Calculating the log determinant for asymmetric weights (here with
symmetric neighbours and symmetry induced by non-constant numbers of
neighbours) may be carried out using eigenvalues as before, but the
result may be a complex vector (here it is not, as discussed below). The
appropriate <code>determinant</code> method for <code>"dgCMatrix"</code>
objects uses an LU decomposition internally:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="fu"><a href="../reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="va">nb_W</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.594376</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">W</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "dgCMatrix"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Matrix"</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/det.html" class="external-link">determinant</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">W</span>, logarithm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">modulus</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.594376</span></span></code></pre>
<p>We can show the internal workings of the method as:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">LU</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/lu-methods.html" class="external-link">lu</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">W</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">slot</a></span><span class="op">(</span><span class="va">LU</span>, <span class="st">"U"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.594376</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="log-determinants-symmetric-by-similarity">Log determinants: symmetric by similarity<a class="anchor" aria-label="anchor" href="#log-determinants-symmetric-by-similarity"></a>
</h3>
<p>The <code>nb2listw</code> function stores components that can be
employed to transform the asymmetric weights matrix to symmetry by
similarity, permitting the same log determinant to be computed using
less costly numerical methods. The <code>"W"</code> style used the
cardinalities of neighbour sets (row sums) to introduce row
standardisation, and they are stored as an attribute:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_W</span><span class="op">$</span><span class="va">weights</span>, <span class="st">"comp"</span><span class="op">)</span><span class="op">$</span><span class="va">d</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/card.html" class="external-link">card</a></span><span class="op">(</span><span class="va">col2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>If we first restore the row-standarised matrix to its binary form
(which must be symmetric), we can pre- and post-multiply by the square
roots of the inverted neighbour counts, yielding a symmetric matrix with
the appropriate properties:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dW</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">W</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">dW</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">dW</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">isd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">isd</span><span class="op">[</span><span class="fl">21</span>,<span class="fl">21</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] Inf</span></span></code></pre>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">isd</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">dW</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">isd</span>, <span class="st">"symmetricMatrix"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Ws</span><span class="op">)</span><span class="op">[</span><span class="fl">21</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">Ws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "dsCMatrix"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Matrix"</span></span></code></pre>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/det.html" class="external-link">determinant</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">Ws</span>, logarithm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">modulus</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.594376</span></span></code></pre>
<p>As can be seen, the division by the square root of zero for entity 21
is not a problem as the row of <code>dW</code> is zero. The
transformation by similarity permits the use of numerical methods for
sparse symmetric matrices (and equivalently for eigenvalues and dense
matrices). Note that this transformation is not available for
intrinsically asymmetric neighbours, or for intrinsically asymmetric
general weights.</p>
</div>
<div class="section level3">
<h3 id="using-eigs-in-rspectra-for-finding-some-eigenvalues">Using <code>eigs</code> in <strong>RSpectra</strong> for finding
some eigenvalues<a class="anchor" aria-label="anchor" href="#using-eigs-in-rspectra-for-finding-some-eigenvalues"></a>
</h3>
<p>In spatial regression, the domain of the spatial coefficient is given
by the inverse of the maximum and minimum eigenvalues. When
<code>n</code> is moderate, we have the eigenvalues anyway, so the
interval for line search is available without extra effort. When
<code>n</code> is somewhat larger, use may be made of the
<code>eigs</code> function in <strong>RSpectra</strong>:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu">spatialreg</span><span class="fu">::</span><span class="fu"><a href="../reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="va">nb_B</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.3212551  0.1638329</span></span></code></pre>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/yixuan/RSpectra" class="external-link">"RSpectra"</a></span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="va">dothis</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">B</span>, k<span class="op">=</span><span class="fl">1</span>, which<span class="op">=</span><span class="st">"SR"</span><span class="op">)</span><span class="op">$</span><span class="va">values</span>, <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">B</span>, k<span class="op">=</span><span class="fl">1</span>, which<span class="op">=</span><span class="st">"LR"</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.3212551  0.1638329</span></span></code></pre>
<p>In this case, the results are trivial with small <code>k</code>.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="../reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="va">nb_W</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.544645  1.000000</span></span></code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html" class="external-link">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">W</span>, k<span class="op">=</span><span class="fl">1</span>, which<span class="op">=</span><span class="st">"SR"</span><span class="op">)</span><span class="op">$</span><span class="va">values</span>, <span class="fu"><a href="https://rdrr.io/pkg/RSpectra/man/eigs.html" class="external-link">eigs</a></span><span class="op">(</span><span class="va">W</span>, k<span class="op">=</span><span class="fl">1</span>, which<span class="op">=</span><span class="st">"LR"</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.544645  1.000000</span></span></code></pre>
<p>Using row-standardisation has the nice feature of setting the upper
bound to unity, and there are graph methods for finding out whether the
lower bound is <code>-1</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-igraph-for-spatial-weights-as-graphs">Using <strong>igraph</strong> for spatial weights as graphs<a class="anchor" aria-label="anchor" href="#using-igraph-for-spatial-weights-as-graphs"></a>
</h2>
<div class="section level3">
<h3 id="converting-from-symmetric-adjacency-matrix-to-graph">Converting from symmetric adjacency matrix to graph<a class="anchor" aria-label="anchor" href="#converting-from-symmetric-adjacency-matrix-to-graph"></a>
</h3>
<p>First we’ll see how to get from sparse matrices to graphs. The mode
of a symmetric matrix is <code>"undirected"</code> by definition:</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "dgCMatrix"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Matrix"</span></span></code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 10824 bytes</span></span></code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://r.igraph.org/" class="external-link">"igraph"</a></span>, quietly<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="va">dothis</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: igraph</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'igraph'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     decompose, spectrum</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     union</span></span></code></pre>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/graph_from_adjacency_matrix.html" class="external-link">graph_from_adjacency_matrix</a></span><span class="op">(</span><span class="va">B</span>, mode<span class="op">=</span><span class="st">"undirected"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "igraph"</span></span></code></pre>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 6544 bytes</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="converting-from-graph-to-symmetric-adjacency-matrix">Converting from graph to symmetric adjacency matrix<a class="anchor" aria-label="anchor" href="#converting-from-graph-to-symmetric-adjacency-matrix"></a>
</h3>
<p>We can also convert this graph back to the same matrix, but note that
<code>as_adjacency_matrix</code> chooses a particular class of sparse
matrix to be returned, so that the conversion process typically leads
many matrices to fewer graph types, and back to fewer matrix types:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Matrix 1.4-2 vulnerability work-around</span></span>
<span><span class="va">ow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"warn"</span><span class="op">)</span><span class="op">$</span><span class="va">warn</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"warn"</span><span class="op">=</span><span class="fl">2L</span><span class="op">)</span></span>
<span><span class="va">B1</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/as_adjacency_matrix.html" class="external-link">as_adjacency_matrix</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">B1</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">B1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "dgCMatrix"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "Matrix"</span></span></code></pre>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">B1</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">B1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 10824 bytes</span></span></code></pre>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">B1</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">B</span>, <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">B1</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"warn"</span><span class="op">=</span><span class="va">ow</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="graph-components-in-spdep">Graph components in <strong>spdep</strong><a class="anchor" aria-label="anchor" href="#graph-components-in-spdep"></a>
</h3>
<p>A simple example of using <strong>igraph</strong> to do the same as
an existing <strong>spdep</strong> function is Nicholas Lewin-Koh’s
<code>n.comp.nb</code> from the early days of the package. It is useful
to know whether an <code>nb</code> object is divided up into separate
subgraphs, and which entities are members of which such subgraph.</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/compon.html" class="external-link">n.comp.nb</a></span><span class="op">(</span><span class="va">col2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  1  2  3 </span></span>
<span><span class="co">## 42  1  6</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="graph-components-in-igraph">Graph components in <strong>igraph</strong><a class="anchor" aria-label="anchor" href="#graph-components-in-igraph"></a>
</h3>
<p>The same result can be obtained using the <code>clusters</code>
function in <strong>igraph</strong>:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span>
<span><span class="va">c1</span><span class="op">$</span><span class="va">no</span> <span class="op">==</span> <span class="va">res</span><span class="op">$</span><span class="va">nc</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">c1</span><span class="op">$</span><span class="va">membership</span>, <span class="va">res</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "names for target but not for current"</span></span></code></pre>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">c1</span><span class="op">$</span><span class="va">csize</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span><span class="op">)</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>The same holds for the row-standardised variant:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">col2</span>, style<span class="op">=</span><span class="st">"W"</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span></span>
<span><span class="va">g1W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/graph_from_adjacency_matrix.html" class="external-link">graph_from_adjacency_matrix</a></span><span class="op">(</span><span class="va">W</span>, mode<span class="op">=</span><span class="st">"directed"</span>, weighted<span class="op">=</span><span class="st">"W"</span><span class="op">)</span></span>
<span><span class="va">c1W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">g1W</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">c1W</span><span class="op">$</span><span class="va">membership</span>, <span class="va">res</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "names for target but not for current"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="shortest-paths-in-weights-matrices-igraph">Shortest paths in weights matrices: <strong>igraph</strong><a class="anchor" aria-label="anchor" href="#shortest-paths-in-weights-matrices-igraph"></a>
</h3>
<p>Finding shortest paths between spatial entities across a given graph
is a way to express closeness. If the graph is connected, that is that
it is possible to traverse the graph edges from any node to any other,
the longest shortest path is then a useful measure. In
<strong>igraph</strong>, the <code>is.connected</code> function tells us
tells us that our graph is not connected, as we know from the figure
above. The diameter measure is then the diameter of the largest
component subgraph. Note that this generates an <code>n</code> x
<code>n</code> matrix:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r.igraph.org/reference/components.html" class="external-link">is_connected</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dg1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/diameter.html" class="external-link">diameter</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span>
<span><span class="va">dg1</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 7</span></span></code></pre>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/distances.html" class="external-link">distances</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">sp_mat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  num [1:49, 1:49] 0 1 1 2 2 3 4 3 3 4 ...</span></span>
<span><span class="co">##  - attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   ..$ : chr [1:49] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   ..$ : chr [1:49] "1" "2" "3" "4" ...</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="shortest-paths-in-weights-matrices-spdep">Shortest paths in weights matrices: <strong>spdep</strong><a class="anchor" aria-label="anchor" href="#shortest-paths-in-weights-matrices-spdep"></a>
</h3>
<p>If we do the same in <strong>spdep</strong>, using <code>nblag</code>
to a maximum number of lag orders - the diameter, but which is unknown
in advance (the largest lag order for which the number of links is
greater than zero), we run into the problem of how to represent missing
neighbour information.</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbl10</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nblag.html" class="external-link">nblag</a></span><span class="op">(</span><span class="va">col2</span>, maxlag<span class="op">=</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 1 neighbour object has 3</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 2 neighbour object has 4</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 3 neighbour object has 8</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 4 neighbour object has 8</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 5 neighbour object has 14</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 6 neighbour object has 29</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 7 neighbour object has 43</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 8 neighbour object has 49</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 9 neighbour object has 49</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Warning in spdep::nblag(col2, maxlag = 10): lag 10 neighbour object has 49</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">nbl10</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/card.html" class="external-link">card</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">zero</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">vals</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">zero</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 7</span></span></code></pre>
<p>If we insert zero into the weights matrix where there is no
connection using <code>zero.policy=TRUE</code>, we generate a zero
shortest path. If we are to create a matrix that matches the one
produced by <code>shortest.paths</code>, we need to set all these
non-structural zeros to infinity (the length of the path between
unconnected nodes), and re-instate structural zeros on the diagonal:</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">nbl10</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">zero</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span>, <span class="fu">spdep</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span>, style<span class="op">=</span><span class="st">"B"</span>, zero.policy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>along<span class="op">=</span><span class="va">lmat</span><span class="op">)</span><span class="op">)</span> <span class="va">mat</span> <span class="op">=</span> <span class="va">mat</span> <span class="op">+</span> <span class="va">i</span><span class="op">*</span><span class="va">lmat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">mat</span><span class="op">[</span><span class="va">mat</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">Inf</span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">mat</span>, <span class="va">sp_mat</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="smirnovanselin-2009-cyclical-matrices">Smirnov/Anselin (2009) cyclical matrices<a class="anchor" aria-label="anchor" href="#smirnovanselin-2009-cyclical-matrices"></a>
</h3>
<p>Another area in which a graph representation might prove useful is in
trying to establish the domain of the spatial coefficient when spatial
weights are row-standardised. In that case by construction we know that
the maximum eigenvalue is 1. If there are multiple blocks, that is graph
components, where the numbers of nodes per block are greater than 1,
then each will have a maximum eigenvalue of 1. The remaining problems
are the numbers of zero eigenvalues (at least the singleton graph
components), and whether any non-singleton component fulfills the
condition termed by Smirnov and Anselin (2009) a cyclical matrix, for
which the minimum eigenvalue is -1. The term cyclical appears to be used
in many different ways, and it is not clear that its use here after
Smirnov and Anselin (2009, pp. 2984-2985) indicates which meaning should
be used to find the relevant graph function. The definition used here is
that a block matrix (subgraph) is cyclical if: “for every location,
every pair of its neighbours are not connected.” That is, if w[i,j] and
w[i,k] are greater than zero, w[j,k] must be zero to meet the
condition.</p>
<p>The internal function find_q1_q2 returns the number of non-singleton
components, and the number of these that meet this condition. It does
this for each block/subgraph by testing the condition until it meets
w[j,k] &gt; 0, at which point it breaks. Smirnov and Anselin (2009)
state that rook neighbours on a regular grid meet the condition:</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_r</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/cell2nb.html" class="external-link">cell2nb</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7</span>, type<span class="op">=</span><span class="st">"rook"</span><span class="op">)</span></span>
<span><span class="va">nb_rW</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="va">nb_r</span>, style<span class="op">=</span><span class="st">"W"</span><span class="op">)</span></span>
<span><span class="fu">spdep</span><span class="fu">:::</span><span class="fu">find_q1_q2</span><span class="op">(</span><span class="va">nb_rW</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1 1</span></span></code></pre>
<p>One block/graph component is found, and this one meets the cyclical
matrix condition, as also shown by the domain:</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html" class="external-link">Re</a></span><span class="op">(</span><span class="fu"><a href="../reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="fu"><a href="../reference/similar.listw.html">similar.listw</a></span><span class="op">(</span><span class="va">nb_rW</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1  1</span></span></code></pre>
<p>This does not apply to the spatial weights we have been using above,
with two non-singleton components, neither meeting the cyclical matrix
condition:</p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">:::</span><span class="fu">find_q1_q2</span><span class="op">(</span><span class="va">nb_W</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 0</span></span></code></pre>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/complex.html" class="external-link">Re</a></span><span class="op">(</span><span class="fu"><a href="../reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="fu"><a href="../reference/similar.listw.html">similar.listw</a></span><span class="op">(</span><span class="va">nb_W</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.544645  1.000000</span></span></code></pre>
<p>By construction, all two-node connected graph components also meet
the condition, as the eigenvalues sum to zero, and the maximum is unity,
so the minimum must be -1.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roger Bivand, Gianfranco Piras.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
